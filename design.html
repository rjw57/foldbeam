
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Design notes &mdash; The foldbeam manual</title>
    
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '2012-08-10',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="The foldbeam manual" href="index.html" />
    <link rel="prev" title="Reference" href="reference.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="reference.html" title="Reference"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">The foldbeam manual</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="design-notes">
<h1>Design notes<a class="headerlink" href="#design-notes" title="Permalink to this headline">¶</a></h1>
<p>Compositing pipeline is nodal. Rendering is a pull operation where a geographic region is requested on an output and a
Node is expected to fulfil the requirements.</p>
<p>An edge therefore consists of an endpoint from which pulled and an input through which &#8216;damage&#8217; events can be pushed.</p>
<p>The overall effect is something like the following:</p>
<p class="graphviz">
<img src="_images/graphviz-39f2b8ccfef2427b9c372f817d9509fcea645b11.png" alt="digraph g {
    rankdir=LR;
    node [
        shape=rectangle
    ];
    &quot;Raster Source&quot; -&gt; &quot;Render Raster&quot; -&gt; &quot;Display&quot;;
    &quot;Vector Source&quot; -&gt; &quot;Render Vector&quot; -&gt; &quot;Display&quot;;
}" />
</p>
<div class="section" id="map-files">
<h2>Map files<a class="headerlink" href="#map-files" title="Permalink to this headline">¶</a></h2>
<div class="highlight-yaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43</pre></div></td><td class="code"><div class="highlight"><pre><span class="c1"># Define styles</span>
<span class="p-Indicator">-</span> <span class="kt">!!Style</span> <span class="nl">&amp;translucent_green</span>
    <span class="l-Scalar-Plain">rgba</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span> <span class="nv">0</span><span class="p-Indicator">,</span> <span class="nv">0.8</span><span class="p-Indicator">,</span> <span class="nv">0</span><span class="p-Indicator">,</span> <span class="nv">0.5</span> <span class="p-Indicator">]</span>

<span class="p-Indicator">-</span> <span class="kt">!!Style</span> <span class="nl">&amp;translucent_blue</span>
    <span class="l-Scalar-Plain">rgba</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span> <span class="nv">0</span><span class="p-Indicator">,</span> <span class="nv">0</span><span class="p-Indicator">,</span> <span class="nv">0.8</span><span class="p-Indicator">,</span> <span class="nv">0.5</span> <span class="p-Indicator">]</span>

<span class="p-Indicator">-</span> <span class="kt">!!Style</span> <span class="nl">&amp;green</span>
    <span class="l-Scalar-Plain">rgb</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span> <span class="nv">0</span><span class="p-Indicator">,</span> <span class="nv">0.8</span><span class="p-Indicator">,</span> <span class="nv">0</span> <span class="p-Indicator">]</span>

<span class="p-Indicator">-</span> <span class="kt">!!Style</span> <span class="nl">&amp;thin</span>
    <span class="l-Scalar-Plain">line_width</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5.0</span>

<span class="c1"># Define geometry sources</span>
<span class="p-Indicator">-</span> <span class="kt">!!Geometry/DatabaseTable</span> <span class="nl">&amp;bus_stops_geom</span>
    <span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="s">&#39;postgres://gis:gis@localhost/bus_stops&#39;</span>

<span class="p-Indicator">-</span> <span class="kt">!!Geometry/DatabaseTable</span> <span class="nl">&amp;buildings_geom</span>
    <span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="s">&#39;postgres://gis:gis@localhost/buildings&#39;</span>

<span class="c1"># Define individual renderer</span>
<span class="p-Indicator">-</span> <span class="kt">!!Renderer/Geometry</span> <span class="nl">&amp;bus_stops</span>
    <span class="l-Scalar-Plain">geometry</span><span class="p-Indicator">:</span> <span class="nv">*bus_stop_geom</span>
    <span class="l-Scalar-Plain">fill</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">True</span>
    <span class="l-Scalar-Plain">stroke</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">True</span>
    <span class="l-Scalar-Plain">fill_style</span><span class="p-Indicator">:</span> <span class="nv">*translucent_green</span>
    <span class="l-Scalar-Plain">stroke_style</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span> <span class="nv">*green</span><span class="p-Indicator">,</span> <span class="nv">*thin</span> <span class="p-Indicator">]</span>

<span class="p-Indicator">-</span> <span class="kt">!!Renderer/Geometry</span> <span class="nl">&amp;buildings</span>
    <span class="l-Scalar-Plain">geometry</span><span class="p-Indicator">:</span> <span class="nv">*bus_stop_geom</span>
    <span class="l-Scalar-Plain">fill</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">True</span>
    <span class="l-Scalar-Plain">stroke</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">False</span>
    <span class="l-Scalar-Plain">fill_style</span><span class="p-Indicator">:</span> <span class="nv">*translucent_blue</span>

<span class="c1"># A test map</span>
<span class="p-Indicator">-</span> <span class="kt">!!HTTPTileServer</span>
    <span class="l-Scalar-Plain">host</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
    <span class="l-Scalar-Plain">port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">8080</span>
    <span class="l-Scalar-Plain">layers</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">stops</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">renderer</span><span class="p-Indicator">:</span> <span class="nv">*bus_stops</span>
        <span class="l-Scalar-Plain">projection</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">EPSG:27700</span>
      <span class="l-Scalar-Plain">buildings</span><span class="p-Indicator">:</span> <span class="nv">*buildings</span> <span class="c1"># will use default projection</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="web-gui">
<h2>Web GUI<a class="headerlink" href="#web-gui" title="Permalink to this headline">¶</a></h2>
<div class="figure">
<img alt="_images/viewer-mockup.png" src="_images/viewer-mockup.png" style="width: 100%;" />
<p class="caption">An example design for the map viewer GUI.</p>
</div>
</div>
<div class="section" id="architecture">
<h2>Architecture<a class="headerlink" href="#architecture" title="Permalink to this headline">¶</a></h2>
<p>The overall system needs to be architectured to pass the &#8216;Range Rover test&#8217; whereby a hypothetical deployment works like
this:</p>
<ol class="arabic simple">
<li>The office/cloud has the overall foldbeam database.</li>
<li>Subsets of this database are synchronised to a laptop.</li>
<li>This laptop acts as the &#8216;field hub&#8217; out on a dig.</li>
<li>Handheld devices join an ad hoc network in the field.</li>
<li>Data capture happens on a device. Data is transparently streamed to the foldbeam laptop.</li>
<li>On returning to the office data is transparently streamed to the office/cloud.</li>
</ol>
<p>The data model has the concept of a &#8216;bucket&#8217; of features. A bucket contains metadata about creator, location, project,
etc. The bucket is itself a collection of features which may be of any type (line, polygon, point, etc). Each bucket is
a single database which may be transparently sychronised online a la CouchDB.</p>
<p>Once gathered, buckets may be filtered, combined and processed in a non-destructive fashion.</p>
<p>Each bucket has a UUID as does each feature within the bucket. Said UUID can be used to determine a unique URN for a
feature or bucket.</p>
<p>An example of use: in the field a device maintains a set of buckets which may be updated individually. The device
advertises these buckets via UPnP for syncing. Buckets may contain features which are themselves references to other
buckets or to procedures for generating features from a bucket.</p>
<p>A database must be complete: any buckets referenced by URN must have a record in the database. This record <em>could</em> be a
reference to another database.</p>
<p>Crucially the bucket data store should be cacheable: it should be trivial to determine if a cache is in sync with a
bucket and it should be possible to incrementally update the cache. The idea is that one could, for example, use a
CouchDB with GeoJSON documents for data storage and PostGIS for indexed retrieval for rendering. The PostGIS database
should be created and updated on demand.</p>
<p>One possible data flow would be the following:</p>
<div class="figure">
<img alt="_images/architecture.png" src="_images/architecture.png" style="width: 100%;" />
<p class="caption">A possible data flow for the foldbeam system.</p>
</div>
<div class="section" id="thoughts">
<h3>Thoughts<a class="headerlink" href="#thoughts" title="Permalink to this headline">¶</a></h3>
<p>The most obvious synchronisation protocol is CouchDB&#8217;s wire protocol. It has the advantage of being HTTP-based, REST-ful
and proven. If one is to use CouchDB, one might as well use GeoJSON or a superset as a feature description.</p>
<p>For example, using CouchDB the following document could describe a bucket:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;&lt;unique id&gt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;foldbeam.bucket&quot;</span><span class="p">,</span>
    <span class="s2">&quot;urn&quot;</span><span class="o">:</span> <span class="s2">&quot;urn:foldbeam:bucket:&lt;id&gt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;metadata&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="c1">// whatever metadata the user wishes to use</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
<p>A feature within a bucket would look like this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;&lt;unique id&gt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;foldbeam.bucket.feature&quot;</span><span class="p">,</span>
    <span class="s2">&quot;urn&quot;</span><span class="o">:</span> <span class="s2">&quot;urn:foldbeam:bucket.feature:&lt;id&gt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;bucket&quot;</span><span class="o">:</span> <span class="s2">&quot;&lt;bucket id&gt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;feature&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="c1">// GeoJSON feature</span>
    <span class="p">},</span>
    <span class="s2">&quot;metadata&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="c1">// whatever metadata the user wishes to use</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This approach allows for single-bucket databases as a special case of many buckets in one database. In addition features
may reference other buckets in other databases or may specify a filtering/mapping operation but the way this is to be
achieved needs to be thought through carefully.</p>
<p>A device may advertise bucket databases via UPnP. Synchronisation is two-way. Database synchronisation is an
all-or-nothing affair. Merging buckets together is dove via bucket references/URNs.</p>
<p>A key concept of buckets is that, due to them being cacheable and incrementally updatable, they can have a view on
themselves appropriate for the use case. For example, a transparent copy of a bucket&#8217;s features can be maintained in a
PostGIS table by a monitoring process. The PostGIS table will be eventually consistent with the CouchDB bucket.</p>
<p>Conflict resolution is <em>only</em> performed by the CouchDB resolution system. All other views let the CouchDB store &#8216;win&#8217;.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Design notes</a><ul>
<li><a class="reference internal" href="#map-files">Map files</a></li>
<li><a class="reference internal" href="#web-gui">Web GUI</a></li>
<li><a class="reference internal" href="#architecture">Architecture</a><ul>
<li><a class="reference internal" href="#thoughts">Thoughts</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="reference.html"
                        title="previous chapter">Reference</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/design.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="reference.html" title="Reference"
             >previous</a> |</li>
        <li><a href="index.html">The foldbeam manual</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Rich Wareham.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>